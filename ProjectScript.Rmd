---
title: "Project Script"
output: html_notebook
---

This script loads in, cleans, and analyzes our project data from the course. 

Roadmap: 

0. Load in packages, metadata, and batch-processed file
1. Clean batch-processed file according to John's tutorial
2. Qualitatively compare to manual file for aster and lupine
3. Visually check output file with built-in graphics
4. Run statistics on final output file
5. Create visuals for presentation

# 0. Load everything in

Install and load in *bouquet* package

```{r}
#install.packages("remotes")
remotes::install_github("jmpowers/bouquet", build_vignettes = TRUE)
```

```{r}
library(tidyverse)
library(bouquet)
library(ggplot2)
```

```{r}
metadata <- read.csv("~/Desktop/GitHub/RMBLVolatile/Data/metadata.csv", header = TRUE)
metadata <- metadata[, c(1, 3:7)]

metadata <- load_metadata(metadata, sample = "file_name", date = "ambient.date", group = c("species", "replicate"), type = "sample_type", amount = "mass")

```

```{r}
source("read_shimadzu.R")
output <- read.shimadzu("~/Desktop/GitHub/RMBLVolatile/Data/Batchrun2.txt")

longdata <- load_longdata(output, sample = "Filename", RT = "Ret.Time", 
                          name = "Name", area = "Area", 
                          match = "SI", maxmatch=100)

longdataclean <- longdata %>%
  select(sample, RT, name, area, match)

```


# 1. Clean batch file! 

## Make sampletable

```{r}
sampletable <- make_sampletable(longdataclean, metadata)
```


## Make chemtable

```{r}
chemtable <- make_chemtable(longdataclean, metadata)
```

## Filter out round 1

```{r}
chemtable <- chemtable %>%
  filter_freq(0.66, group = TRUE) %>%
  filter_area(min_maximum = 5e5) %>%
 # filter_ambient_ratio(sampletable, metadata, ratio = 3)
  filter_ambient_date(sampletable, metadata, ratio = 4, prop_dates = .1)
```

## Make preliminary final filter

```{r}
chemtable <- chemtable %>% 
  combine_filters() %>% 
  within(filter_final <- 
              ((filter_freq.Heliomeris_multiflora == "OK" | filter_freq.Lupinus_argenteus == "OK")
               & filter_area == "OK" & filter_ambient_date == "OK"))

```

## Diagnose what filters are doing what

```{r}
plot_filters(chemtable, option = "prop")
```

```{r}
plot_filters(chemtable, option = "rarity", yrange=2.5, fontsize=2.5, pointsize=15)
```


```{r}
plot_filters(chemtable, option = "ambient", yrange=4, pointsize=6)
```

